<launch>
  <!-- CogniPlan + 四足动力学可视化：与 cogniplan_nav 相同的规划，但用 Champ 腿显示 -->
  <arg name="max_vel" default="2.0" />
  <arg name="max_acc" default="2.0" />
  <arg name="map_x_size" default="20.0" />
  <arg name="map_y_size" default="30.0" />
  <arg name="planning_height" default="0.4" doc="Robot init z / planning height (meters)" />
  <arg name="robot_type" default="zsl-1" doc="Robot type: zsl-1 (智身) or go2 (宇树)" />
  <arg name="init_x" default="-6.0" />
  <arg name="init_y" default="10.0" />
  <arg name="init_yaw" default="-1.57" />
  <arg name="rviz" default="true" />
  <!-- Map loading params -->
  <arg name="pcd_file" default="office.pcd" />
  <arg name="rotate_z" default="0.0" />
  <arg name="trans_x" default="0.0" />
  <arg name="trans_y" default="0.0" />
  <arg name="trans_z" default="-0.3" />

  <!-- CogniPlan Nav model paths -->
  <arg name="model_path" default="$(find nav_exp_env)/cogniplan/checkpoints/cogniplan_nav_pred7" />
  <arg name="generator_path" default="$(find nav_exp_env)/cogniplan/checkpoints/wgan_inpainting" />

  <!-- ============== Base Environment (四足版) ============== -->
  <!-- Provides: map_loader, odom simulator (with gait dynamics), local_sensing, gait_joint_publisher, RViz -->
  <include file="$(find nav_exp_env)/base_env/launch/nav_env_legged.launch">
    <arg name="rviz" value="false" />
    <arg name="use_click_pos_cmd" value="false" />
    <arg name="map_x_size" value="$(arg map_x_size)" />
    <arg name="map_y_size" value="$(arg map_y_size)" />
    <arg name="planning_height" value="$(arg planning_height)" />
    <arg name="robot_type" value="$(arg robot_type)" />
    <arg name="init_x" value="$(arg init_x)" />
    <arg name="init_y" value="$(arg init_y)" />
    <arg name="init_yaw" value="$(arg init_yaw)" />
    <arg name="pcd_file" value="$(arg pcd_file)" />
    <arg name="rotate_z" value="$(arg rotate_z)" />
    <arg name="trans_x" value="$(arg trans_x)" />
    <arg name="trans_y" value="$(arg trans_y)" />
    <arg name="trans_z" value="$(arg trans_z)" />
  </include>

  <!-- ============== TF: world -> map ============== -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="world_to_map"
        args="0 0 0 0 0 0 world map" />

  <!-- ============== CogniPlan Nav Planner ============== -->
  <!-- Use forexnav conda env for PyTorch / scikit-learn / scikit-image deps -->
  <node pkg="nav_exp_env" type="rl_planner_nav.py" name="rl_planner_nav" output="screen"
        cwd="node" ns="cogniplan"
        launch-prefix="/home/songhy/miniconda3/envs/forexnav/bin/python3">
    <!-- Topic remapping -->
    <remap from="/projected_map" to="/local_sensing/occupancy_grid" />
    <remap from="/state_estimation" to="/odom" />

    <!-- Parameters -->
    <param name="model_path" value="$(arg model_path)" />
    <param name="generator_path" value="$(arg generator_path)" />
    <param name="publish_graph" type="bool" value="true"/>
    <param name="map_resolution" value="0.1"/>
    <param name="waypoint_threshold" value="1.0"/>
    <param name="goal_reached_threshold" value="0.5"/>
    <param name="replanning_frequency" value="2.0"/>
  </node>

  <!-- ============== B-spline Trajectory Commander ============== -->
  <!-- /planning/raw_path -> /planning/pos_cmd (PositionCommand with full PVA) -->
  <node pkg="nav_exp_env" type="frtree_traj_cmd.py" name="cogniplan_traj_cmd" output="screen">
    <param name="path_topic" value="/planning/raw_path" />
    <param name="max_vel"  value="$(arg max_vel)" />
    <param name="max_acc"  value="$(arg max_acc)" />
    <param name="publish_rate" value="50.0" />
    <param name="fixed_z" value="$(arg planning_height)" />
    <param name="lookahead_dist" value="0.3" />
  </node>

  <!-- ============== RViz (四足可视化) ============== -->
  <node pkg="rviz" type="rviz" name="rviz_cogniplan" output="screen"
        args="-d $(find nav_exp_env)/proposed/config/forex.rviz -f odom"
        if="$(arg rviz)" />
</launch>
