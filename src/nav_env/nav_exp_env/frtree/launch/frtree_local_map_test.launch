<launch>
  <!-- ============== Arguments ============== -->
  <arg name="map_name" default="office1" />
  <arg name="rviz" default="true" />
  <arg name="use_click_pos_cmd" default="true" />
  <arg name="click_fixed_z" default="1.0" />
  <arg name="click_fixed_yaw" default="0.0" />

  <!-- Map configs: office1 -->
  <arg name="init_x" default="-6.0" />
  <arg name="init_y" default="10.0" />
  <arg name="init_yaw" default="-1.57" />
  <arg name="rotate_z" default="0.0" />
  <arg name="trans_x" default="0.0" />
  <arg name="trans_y" default="0.0" />
  <arg name="pcd_file" default="office.pcd" />

  <!-- ============== Map Loader ============== -->
  <!-- Fix libusb conflict: system lib must come before MVS -->
  <node pkg="map_loader" type="map_loader_node" name="map_loader" ns="map_loader" output="screen">
    <param name="pcd_path" value="$(find map_loader)/resource/$(arg pcd_file)" />
    <param name="rotate_z" value="$(arg rotate_z)" />
    <param name="trans_x" value="$(arg trans_x)" />
    <param name="trans_y" value="$(arg trans_y)" />
    <param name="trans_z" value="-0.3" />
    <param name="frame_id" value="map" />
  </node>

  <!-- ============== TF Transforms ============== -->
  <!-- world -> map -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="world_to_map"
        args="0 0 0 0 0 0 world map" />
  
  <!-- map -> odom -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="map_to_odom"
        args="0 0 0 0 0 0 map odom" />
  
  <!-- base_link -> base -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="base_link_to_base"
        args="0 0 0 0 0 0 base_link base" />
  
  <!-- base -> unitree_scan (required by local_map for scan sensor) -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="base_to_unitree_scan"
        args="0 0 0 0 0 0 base unitree_scan" />
  
  <!-- base -> camera_depth_optical_frame (required by local_map for pointcloud sensor) -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="base_to_camera"
        args="0 0 0 0 0 0 base camera_depth_optical_frame" />

  <!-- ============== Odometry Simulator ============== -->
  <node pkg="nav_exp_env" type="simple_odom_simulator.py" name="simple_odom_simulator" output="screen">
    <param name="init_x" value="$(arg init_x)" />
    <param name="init_y" value="$(arg init_y)" />
    <param name="init_z" value="1.0" />
    <param name="init_yaw" value="$(arg init_yaw)" />
    <param name="publish_frequency" value="50.0" />
    <param name="max_vel" value="10.0" />
    <param name="max_omega" value="5.0" />
  </node>

  <!-- ============== Clicked point -> pos_cmd ============== -->
  <node pkg="nav_exp_env" type="clicked_point_to_pos_cmd.py" name="clicked_point_to_pos_cmd" output="screen"
        if="$(arg use_click_pos_cmd)">
    <param name="fixed_z" value="$(arg click_fixed_z)" />
    <param name="fixed_yaw" value="$(arg click_fixed_yaw)" />
    <param name="frame_id" value="map" />
  </node>

  <!-- ============== Local Sensing (generates /velodyne_points) ============== -->
  <node pkg="local_sensing" type="local_sensing_node" name="local_sensing" ns="local_sensing" output="screen">
    <rosparam file="$(find local_sensing)/params/local_sensing.yaml" command="load" />
    <param name="map/x_size" value="132.0" />
    <param name="map/y_size" value="132.0" />
    <param name="map/resolution" value="0.1" />
    <param name="use_relative_cloud" value="true" />
    <param name="cloud_frame_id" value="unitree_scan" />
    <remap from="global_map" to="/map_loader/global_cloud" />
    <remap from="odometry" to="/odom" />
  </node>

  <!-- ============== Point Cloud Relay (local_sensing -> /velodyne_points) ============== -->
  <node pkg="topic_tools" type="relay" name="pointcloud_relay" 
        args="/local_sensing/cloud /velodyne_points" />

  <!-- ============== FRTree Local Map ============== -->
  <!-- Use minimal config - let code use defaults to avoid param bugs -->
  <node pkg="frtree_local_map" name="local_map" type="frtree_local_map_node" output="screen"
        launch-prefix="bash -c 'sleep 3; exec $0 $@' ">
    <!-- Frame IDs must match TF tree -->
    <param name="local_map/frame_id" value="map"/>
    <param name="local_map/base_id" value="base"/>
    <param name="local_map/pointcloud_sensor_frame_id" value="camera_depth_optical_frame"/>
    <param name="local_map/scan_sensor_frame_id" value="unitree_scan"/>
  </node>

  <!-- ============== Odometry Path Publisher ============== -->
  <node pkg="nav_exp_env" type="odom_path_publisher.py" name="odom_path_publisher" output="screen">
    <param name="max_path_length" value="2000" />
    <param name="publish_rate" value="10.0" />
    <param name="min_distance" value="0.05" />
  </node>

  <!-- ============== RViz ============== -->
  <node pkg="rviz" type="rviz" name="rviz" 
        args="-d $(find frtree_local_map)/rviz/local_map_test.rviz"
        if="$(arg rviz)" />

</launch>
