<?xml version="1.0"?>
<launch>
    <!-- Launch arguments -->
    <arg name="rviz" default="true" doc="Whether to launch RViz" />

    <!-- ============== Base Environment ============== -->
    <!-- Provides: map_loader, odom simulator, local_sensing, odom path publisher, world->odom TF -->
    <include file="$(find nav_exp_env)/base_env/launch/nav_env.launch">
        <arg name="rviz" value="false" />
        <arg name="use_click_pos_cmd" value="false" />
        <arg name="map_x_size" value="132" />
        <arg name="map_y_size" value="132" />
    </include>

    <!-- ============== Extra TFs for FRTree ============== -->
    <!-- world -> map (identity, for hardcoded "map" frame refs in pop_planner) -->
    <node pkg="tf2_ros" type="static_transform_publisher" name="world_to_map"
          args="0 0 0 0 0 0 world map" />

    <!-- base_link -> base (identity, bridges nav_env's odom->base_link to pop_planner's odom->base) -->
    <node pkg="tf2_ros" type="static_transform_publisher" name="base_link_to_base"
          args="0 0 0 0 0 0 base_link base" />

    <!-- base -> unitree_scan (identity, hardcoded TF lookup in local_decomp.cpp) -->
    <node pkg="tf2_ros" type="static_transform_publisher" name="base_to_unitree_scan"
          args="0 0 0 0 0 0 base unitree_scan" />

    <!-- base -> camera_depth_optical_frame (identity, for local_map pointcloud sensor) -->
    <node pkg="tf2_ros" type="static_transform_publisher" name="base_to_camera"
          args="0 0 0 0 0 0 base camera_depth_optical_frame" />

    <!-- ============== Point Cloud Relay ============== -->
    <!-- pop_planner subscribes to /velodyne_points, nav_env publishes /local_sensing/cloud -->
    <node pkg="topic_tools" type="relay" name="pointcloud_relay"
          args="/local_sensing/cloud /velodyne_points" />

    <!-- ============== FRTree Planner ============== -->
    <!-- Delay startup to wait for TF tree to be complete -->
    <!-- FRTree publishes /planning/pos_cmd as PoseStamped (position only),
         remap it away so frtree_traj_cmd can publish PositionCommand (with PVA) instead.
         Also remap cmd_vel to prevent conflict with simple_odom_simulator. -->
    <node pkg="pop_planner" name="planner" type="pop_planner_node" output="screen"
          launch-prefix="bash -c 'sleep 3; exec $0 $@' ">
        <rosparam file="$(find pop_planner)/launch/config/pop_plan_fsm_param.yaml" command="load" />
        <param name="plan_manager/lidar_link_name" value="base_link" />
        <remap from="local_map/odometry/state_estimation" to="/odom"/>
        <remap from="goal" to="/move_base_simple/goal"/>
        <remap from="/planning/pos_cmd" to="/planning/frtree_raw_pos_cmd"/>
        <!-- Prevent FRTree's cmd_vel from conflicting with odom simulator -->
        <remap from="cmd_vel" to="/planning/frtree_raw_cmd_vel"/>
        <remap from="/cmd_vel" to="/planning/frtree_raw_cmd_vel"/>
    </node>

    <!-- ============== FRTree Trajectory PVA Commander ============== -->
    <!-- Subscribes to FRTree's localPlan (nav_msgs/Path, primary) and
         /traj_pose_vis (PoseArray, fallback), fits cubic B-spline,
         publishes PositionCommand with full PVA to drive odom simulator -->
    <node pkg="nav_exp_env" name="frtree_traj_cmd" type="frtree_traj_cmd.py" output="screen">
        <param name="max_vel" value="2.0" />
        <param name="max_acc" value="2.0" />
        <param name="traj_topic" value="/traj_pose_vis" />
        <param name="path_topic" value="/localPlan" />
        <param name="fixed_z" value="1.0" />
    </node>

    <!-- ============== RViz ============== -->
    <node if="$(arg rviz)" pkg="rviz" type="rviz" name="rviz"
          args="-d $(find nav_exp_env)/frtree/config/frtree.rviz" output="screen" />
</launch>
